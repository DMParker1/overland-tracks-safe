<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Overland Tracks (Privacy-Safe)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    html, body, #map { height: 100%; margin: 0; }
    .legend {
      position: absolute; z-index: 1000; right: 10px; top: 10px;
      background: #fff; border: 1px solid #ccc; border-radius: 8px;
      padding: 8px 10px; font: 14px/1.2 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      box-shadow: 0 1px 4px rgba(0,0,0,.12);
    }
    .nodata {
      position: absolute; z-index: 900; left: 50%; top: 18px; transform: translateX(-50%);
      background: #fff; border: 1px solid #ddd; border-radius: 6px; padding: 8px 10px;
      font: 14px/1.2 system-ui, -apple-system, Segoe UI, Roboto, sans-serif; color: #444;
      box-shadow: 0 1px 3px rgba(0,0,0,.1);
    }
    .leaflet-control-layers-expanded { max-height: 45vh; overflow: auto; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="legend">
    <strong>Overland Tracks</strong><br/>
    Source: <code>docs/data/processed/tracks_safe.geojson</code><br/>
    (geofenced · delayed · optional jitter)
  </div>
  <div id="nodata" class="nodata" style="display:none;">No tracks yet. Run “Build sanitized map” in Actions.</div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // Initial map
    const map = L.map('map', { zoomControl: true }).setView([33.7, -117.8], 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Deterministic color per base filename
    function colorFromString(s) {
      let h = 0;
      for (let i = 0; i < s.length; i++) h = s.charCodeAt(i) + ((h << 5) - h);
      const hue = ((h % 360) + 360) % 360;
      return `hsl(${hue}, 60%, 45%)`;
    }

    // Load sanitized GeoJSON
    fetch('data/processed/tracks_safe.geojson', { cache: 'no-store' })
      .then(r => {
        if (!r.ok) throw new Error('Failed to load GeoJSON');
        return r.json();
      })
      .then(geo => {
        const feats = (geo && geo.features) ? geo.features : [];
        if (!feats.length) {
          document.getElementById('nodata').style.display = 'block';
          return;
        }

        const groups = {}; // base filename -> LayerGroup
        const layer = L.geoJSON(geo, {
          style: f => {
            const base = String(f.properties?.name || 'track').split('_')[0];
            return { weight: 3, color: colorFromString(base) };
          },
          onEachFeature: (f, l) => {
            const base = String(f.properties?.name || 'track').split('_')[0];
            (groups[base] ||= L.layerGroup()).addLayer(l);
            l.bindPopup(base);
          }
        }).addTo(map);

        // Build overlays from groups and add toggle control
        const overlays = {};
        Object.keys(groups).sort().forEach(k => { overlays[k] = groups[k]; });
        L.control.layers(null, overlays, { collapsed: false }).addTo(map);

        // Fit map to data (with padding)
        try {
          const b = layer.getBounds();
          if (b.isValid()) map.fitBounds(b, { padding: [20, 20] });
        } catch (_) { /* ignore */ }
      })
      .catch(err => {
        console.error(err);
        document.getElementById('nodata').textContent = 'Could not load tracks.';
        document.getElementById('nodata').style.display = 'block';
      });
  </script>
</body>
</html>
